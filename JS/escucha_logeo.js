


(function() {
    const originalSetItem = sessionStorage.setItem;
    sessionStorage.setItem = function(key, value) {
        const event = new Event('sessionStorageChange');
        event.key = key;
        event.newValue = value;
        window.dispatchEvent(event);
        originalSetItem.apply(this, arguments);
    };
})();

window.addEventListener('localStorage', (event) => {

    console.log('Cambio detectado en sessionStorage');
    console.log(`Clave: ${event.key}`);
    console.log(`Nuevo valor: ${event.newValue}`);

    const token = parseJwts(event.newValue)
    const perfil = document.getElementById('btn-ingresar')
    perfil.textContent = token.user.name
});

function parseJwts (token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
}

async function CerrarSesion() {

    console.log('Vamos a cerrar sesion');
    

    try {
        const response = await fetch('/auth/cerrar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                token: localStorage.getItem('token')
            })
        })
    
        const data = await response.json()
    
        console.log(data);
        
        const frame = document.querySelector('iframe')
    
        localStorage.removeItem('name')
        localStorage.removeItem('sesion')
        localStorage.removeItem('token')
        window.parent.location.reload()
    } catch (error) {
        console.log(error);
        
    }

    
}

console.log(new Date().getFullYear() + '-' + new Date().getUTCMonth() + '-' + new Date().getDay());

if (localStorage.getItem('name')) {


    const btnLogin = document.getElementById('btn-ingresar')
    btnLogin.remove()

    const nav = document.querySelector('.menu-dropdown')

    const dropdownHTML = `
        <a id="perfil">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="#235583" width="22" height="24" viewBox="0 0 22 24" >
                        <path d="M11.0075 11.8644C9.46105 11.8644 8.14038 11.3169 7.04549 10.222C5.9506 9.12714 5.40316 7.80647 5.40316 6.26003C5.40316 4.71381 5.9506 3.39447 7.04549 2.30203C8.14038 1.20981 
                              9.46105 0.663696 11.0075 0.663696C12.5539 0.663696 13.8746 1.20981 14.9695 2.30203C16.0644 3.39447 16.6118 4.71381 16.6118 6.26003C16.6118 7.80647 16.0644 9.12714 14.9695 10.222C13.8746 
                              11.3169 12.5539 11.8644 11.0075 11.8644ZM0.0698242 23.0734V19.053C0.0698242 18.2479 0.278047 17.508 0.694491 16.8334C1.11094 16.1585 1.66427 15.6435 2.35449 15.2884C3.74827 14.5941 5.16682 14.0721 
                              6.61016 13.7224C8.05327 13.3726 9.51904 13.1977 11.0075 13.1977C12.5059 13.1977 13.9769 13.3713 15.4205 13.7184C16.864 14.0655 18.2774 14.5861 19.6605 15.2804C20.3507 15.6348 20.904 16.1487 21.3205 
                              16.822C21.7369 17.4954 21.9452 18.2388 21.9452 19.0524V23.0734H0.0698242ZM3.10316 20.04H18.9118V19.0927C18.9118 18.8534 18.8507 18.6358 18.7285 18.44C18.6063 18.2443 18.4452 18.092 18.2452 17.9834C17.0772 17.4047 15.8899 
                              16.968 14.6835 16.6734C13.4773 16.3785 12.2519 16.231 11.0075 16.231C9.77371 16.231 8.54838 16.3785 7.33149 16.6734C6.1146 16.968 4.92738 17.4047 3.76982 17.9834C3.56982 18.092 3.40871 18.2443 3.28649 18.44C3.16427 18.6358 
                              3.10316 18.8534 3.10316 19.0927V20.04ZM11.0072 8.83103C11.714 8.83103 12.3194 8.57936 12.8232 8.07603C13.3267 7.5727 13.5785 6.96748 13.5785 6.26036C13.5785 5.55347 13.3268 4.94959 12.8235 4.4487C12.3199 3.94759 11.7147 3.69703 
                              11.0078 3.69703C10.3009 3.69703 9.6956 3.94803 9.19182 4.45003C8.68827 4.95203 8.43649 5.55536 8.43649 6.26003C8.43649 6.96714 8.68816 7.57248 9.19149 8.07603C9.69504 8.57936 10.3003 8.83103 11.0072 8.83103Z" />
                    </svg>
                    
                 </a>
            <div class="modal_perfil abrir_modal" id="modal_perfil">
                 <div class="titulo_modal_perfil">
                     <a ><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <mask id="mask0_1444_18976" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="32" height="32">
                        <rect width="32" height="32" fill="#D9D9D9"/>
                        </mask>
                        <path d="M8.48221 22.6802C9.64887 21.8242 10.9473 21.1515 12.3775 20.6622C13.8077 20.1728 15.3098 19.9282 16.8839 19.9282C18.458 19.9282 19.9637 20.1768 21.401 20.6742C22.8383 21.1715 24.132 21.8428 25.2822 22.6882C26.0666 21.7717 26.6764 20.7504 27.1115 19.6242C27.5466 18.4977 27.7641 17.2896 27.7641 15.9998C27.7641 13.0761 26.7029 10.5833 24.5805 8.52151C22.4581 6.45973 19.892 5.42884 16.8822 5.42884C13.8724 5.42884 11.3063 6.45973 9.18392 8.52151C7.0615 10.5833 6.0003 13.0761 6.0003 15.9998C6.0003 17.2843 6.21647 18.4897 6.64883 19.6162C7.08118 20.7424 7.69231 21.7637 8.48221 22.6802ZM16.8822 17.4048C15.5106 17.4048 14.3561 16.9508 13.4189 16.0428C12.4815 15.1348 12.0127 14.0147 12.0127 12.6825C12.0127 11.3501 12.4815 10.2285 13.4189 9.31784C14.3561 8.4074 15.5106 7.95218 16.8822 7.95218C18.2538 7.95218 19.4083 8.4074 20.3455 9.31784C21.2829 10.2285 21.7517 11.3501 21.7517 12.6825C21.7517 14.0147 21.2829 15.1348 20.3455 16.0428C19.4083 16.9508 18.2538 17.4048 16.8822 17.4048ZM16.8815 29.6042C14.9451 29.6042 13.1254 29.2475 11.4226 28.5342C9.7199 27.8208 8.23721 26.851 6.97446 25.6245C5.71195 24.3978 4.71353 22.9573 3.97922 21.3028C3.2449 19.6482 2.87775 17.8803 2.87775 15.9992C2.87775 14.1181 3.2449 12.3504 3.97922 10.6962C4.71353 9.04218 5.71195 7.60184 6.97446 6.37518C8.23721 5.14873 9.72013 4.17884 11.4232 3.46551C13.1266 2.75217 14.9465 2.39551 16.8829 2.39551C18.8193 2.39551 20.639 2.75217 22.3419 3.46551C24.0445 4.17884 25.5272 5.14873 26.79 6.37518C28.0525 7.60184 29.0509 9.0424 29.7852 10.6968C30.5195 12.3515 30.8867 14.1194 30.8867 16.0005C30.8867 17.8816 30.5195 19.6493 29.7852 21.3035C29.0509 22.9575 28.0525 24.3978 26.79 25.6245C25.5272 26.851 24.0443 27.8208 22.3412 28.5342C20.6378 29.2475 18.818 29.6042 16.8815 29.6042ZM16.8822 26.5708C18.0672 26.5708 19.1809 26.4053 20.2233 26.0742C21.2656 25.7431 22.2327 25.2658 23.1249 24.6425C22.222 24.0141 21.2562 23.5356 20.2275 23.2072C19.1987 22.8785 18.0836 22.7142 16.8822 22.7142C15.6808 22.7142 14.5671 22.8785 13.5411 23.2072C12.5151 23.5356 11.5505 24.0141 10.6474 24.6425C11.5396 25.2658 12.5055 25.7431 13.5452 26.0742C14.5849 26.4053 15.6972 26.5708 16.8822 26.5708ZM16.8822 14.6188C17.455 14.6188 17.9305 14.4352 18.3086 14.0678C18.6865 13.7007 18.8755 13.239 18.8755 12.6825C18.8755 12.1258 18.6865 11.6626 18.3086 11.2928C17.9305 10.9231 17.455 10.7382 16.8822 10.7382C16.3094 10.7382 15.8339 10.9231 15.4558 11.2928C15.0779 11.6626 14.8889 12.1258 14.8889 12.6825C14.8889 13.239 15.0779 13.7007 15.4558 14.0678C15.8339 14.4352 16.3094 14.6188 16.8822 14.6188Z" fill="white"/>
                        </svg>nombre apellido</a>
                 </div>
                 <div class="cuerpo_modal_perfil">
                     <div class="subcuerpo_modal_perfil">
                         <a onclick="CambiarFrame(this)" jual="1"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <mask id="mask0_368_7666" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="24" height="24">
                            <rect width="24" height="24" fill="#D9D9D9"/>
                            </mask>
                            <path d="M5.07175 22.2032C4.44209 22.2032 3.9055 21.9815 3.462 21.538C3.0185 21.0945 2.79675 20.5579 2.79675 19.9282V8.12549C2.79675 7.49583 3.0185 6.95924 3.462 6.51574C3.9055 6.07224 4.44209 5.85049 5.07175 5.85049H6.91025C6.91025 4.43933 7.40575 3.23824 8.39675 2.24724C9.38775 1.25624 10.5888 0.760742 12 0.760742C13.4112 0.760742 14.6123 1.25624 15.6033 2.24724C16.5943 3.23824 17.0898 4.43933 17.0898 5.85049H18.9283C19.5579 5.85049 20.0945 6.07224 20.538 6.51574C20.9815 6.95924 21.2033 7.49583 21.2033 8.12549V19.9282C21.2033 20.5579 20.9815 21.0945 20.538 21.538C20.0945 21.9815 19.5579 22.2032 18.9283 22.2032H5.07175ZM5.07175 19.9282H18.9283V8.12549H5.07175V19.9282ZM12 14.2152C13.4112 14.2152 14.6123 13.7197 15.6033 12.7287C16.5943 11.7379 17.0898 10.5368 17.0898 9.12549H14.8148C14.8148 9.91099 14.542 10.5765 13.9965 11.122C13.451 11.6675 12.7855 11.9402 12 11.9402C11.2145 11.9402 10.549 11.6675 10.0035 11.122C9.458 10.5765 9.18525 9.91099 9.18525 9.12549H6.91025C6.91025 10.5368 7.40575 11.7379 8.39675 12.7287C9.38775 13.7197 10.5888 14.2152 12 14.2152ZM9.18525 5.85049H14.8148C14.8148 5.06499 14.542 4.39949 13.9965 3.85399C13.451 3.30849 12.7855 3.03574 12 3.03574C11.2145 3.03574 10.549 3.30849 10.0035 3.85399C9.458 4.39949 9.18525 5.06499 9.18525 5.85049Z" fill="#6F6D6D"/>
                            </svg>Mis compras</a>
                         <a onclick="CambiarFrame(this)" jual="2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <mask id="mask0_414_2557" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="24" height="24">
                              <rect width="24" height="24" fill="#1C1C1C"/>
                            </mask>
                              <path d="M11.994 21.2747L10.4065 19.8492C8.70719 18.3205 7.30261 17.0002 6.19277 15.8882C5.08277 14.7763 4.20177 13.7779 3.54977 12.8929C2.89777 12.0079 2.4416 11.1928 2.18127 10.4474C1.92094 9.70226 1.79077 8.93635 1.79077 8.14968C1.79077 6.52335 2.33519 5.16526 3.42402 4.07543C4.51286 2.98543 5.86952 2.44043 7.49402 2.44043C8.35652 2.44043 9.17744 2.61576 9.95677 2.96643C10.7363 3.31726 11.4154 3.81601 11.994 4.46268C12.5727 3.81601 13.2518 3.31726 14.0313 2.96643C14.8108 2.61576 15.6317 2.44043 16.494 2.44043C18.122 2.44043 19.4815 2.98543 20.5725 4.07543C21.6637 5.16526 22.2093 6.52335 22.2093 8.14968C22.2093 8.93235 22.0801 9.69626 21.8218 10.4414C21.5634 11.1868 21.1073 12.0009 20.4533 12.8839C19.7993 13.7669 18.9163 14.7653 17.8043 15.8792C16.6924 16.9932 15.2849 18.3165 13.5815 19.8492L11.994 21.2747ZM11.994 18.2099C13.586 16.7766 14.8957 15.5524 15.923 14.5374C16.9505 13.5224 17.7613 12.6388 18.3553 11.8864C18.9493 11.1341 19.3609 10.4668 19.5903 9.88443C19.8196 9.3021 19.9343 8.72393 19.9343 8.14993C19.9343 7.16576 19.6069 6.34726 18.9523 5.69443C18.2974 5.04176 17.479 4.71543 16.497 4.71543C15.7277 4.71543 15.0137 4.93626 14.355 5.37793C13.6962 5.8196 13.2418 6.3821 12.9918 7.06543H11.0023C10.7541 6.3821 10.2992 5.8196 9.63752 5.37793C8.97586 4.93626 8.26194 4.71543 7.49577 4.71543C6.51744 4.71543 5.70219 5.04176 5.05002 5.69443C4.39785 6.34726 4.07177 7.16568 4.07177 8.14968C4.07177 8.72801 4.18736 9.31051 4.41852 9.89718C4.64952 10.4838 5.06219 11.1531 5.65652 11.9049C6.25069 12.6569 7.05952 13.5394 8.08302 14.5524C9.10636 15.5654 10.41 16.7846 11.994 18.2099Z" fill="#6F6D6D"/>
                          </svg>Mis favoritos</a>
                         <a onclick="CambiarFrame(this)" jual="3"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <mask id="mask0_414_2549" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="24" height="24">
                              <rect width="24" height="24" fill="#D9D9D9"/>
                            </mask>
                              <path d="M4.07175 22.2034C3.44209 22.2034 2.9055 21.9816 2.462 21.5381C2.0185 21.0946 1.79675 20.558 1.79675 19.9284V9.07188C1.79675 8.44221 2.0185 7.90562 2.462 7.46212C2.9055 7.01862 3.44209 6.79688 4.07175 6.79688H8.79675V3.94037C8.79675 3.33454 9.00259 2.82588 9.41425 2.41438C9.82575 2.00271 10.3344 1.79688 10.9403 1.79688H13.0598C13.6656 1.79688 14.1743 2.00271 14.5858 2.41438C14.9974 2.82588 15.2033 3.33454 15.2033 3.94037V6.79688H19.9283C20.5579 6.79688 21.0945 7.01862 21.538 7.46212C21.9815 7.90562 22.2033 8.44221 22.2033 9.07188V19.9284C22.2033 20.558 21.9815 21.0946 21.538 21.5381C21.0945 21.9816 20.5579 22.2034 19.9283 22.2034H4.07175ZM4.07175 19.9284H19.9283V9.07188H15.1913C15.1714 9.62988 14.9507 10.1027 14.529 10.4904C14.1075 10.878 13.6178 11.0719 13.0598 11.0719H10.9403C10.3823 11.0719 9.8925 10.878 9.471 10.4904C9.04934 10.1027 8.82859 9.62988 8.80875 9.07188H4.07175V19.9284ZM6 18.0719H12V17.6219C12 17.3385 11.9208 17.076 11.7625 16.8344C11.6042 16.5927 11.3833 16.4052 11.1 16.2719C10.7667 16.1219 10.4292 16.0094 10.0875 15.9344C9.74584 15.8594 9.38334 15.8219 9 15.8219C8.61667 15.8219 8.25417 15.8594 7.9125 15.9344C7.57084 16.0094 7.23334 16.1219 6.9 16.2719C6.61667 16.4052 6.39584 16.5927 6.2375 16.8344C6.07917 17.076 6 17.3385 6 17.6219V18.0719ZM14 16.5719H18V15.0719H14V16.5719ZM9 15.0719C9.41667 15.0719 9.77084 14.926 10.0625 14.6344C10.3542 14.3427 10.5 13.9885 10.5 13.5719C10.5 13.1552 10.3542 12.801 10.0625 12.5094C9.77084 12.2177 9.41667 12.0719 9 12.0719C8.58334 12.0719 8.22917 12.2177 7.9375 12.5094C7.64584 12.801 7.5 13.1552 7.5 13.5719C7.5 13.9885 7.64584 14.3427 7.9375 14.6344C8.22917 14.926 8.58334 15.0719 9 15.0719ZM14 13.5719H18V12.0719H14V13.5719ZM11.012 8.85663H12.988V4.01212H11.012V8.85663Z" fill="#6F6D6D"/>
                          </svg>Mis Datos</a>
                     </div>
                    
                     <a class="cerrar_sesion" onClick="CerrarSesion(this); CambiarFrame(this)" jual="0"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                       <mask id="mask0_368_7679" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="24" height="24">
                         <rect width="24" height="24" fill="#D9D9D9"/>
                       </mask>
                         <path d="M19.228 13.1376H6.22496V10.8626H19.228L17.4775 9.30063L19.2677 7.67137L24.1375 12.0001L19.2677 16.3289L17.4775 14.6996L19.228 13.1376ZM13.2728 8.86263V5.07188H2.84996V18.9284H13.2728V15.1376H15.8322V18.9284C15.8322 19.558 15.5827 20.0946 15.0838 20.5381C14.5848 20.9816 13.9812 21.2034 13.2728 21.2034H2.84996C2.14159 21.2034 1.53793 20.9816 1.03899 20.5381C0.540057 20.0946 0.290588 19.558 0.290588 18.9284V5.07188C0.290588 4.44221 0.540057 3.90562 1.03899 3.46212C1.53793 3.01862 2.14159 2.79688 2.84996 2.79688H13.2728C13.9812 2.79688 14.5848 3.01862 15.0838 3.46212C15.5827 3.90562 15.8322 4.44221 15.8322 5.07188V8.86263H13.2728Z" fill="#6F6D6D"/>
                     </svg>Cerrar Sesi√≥n</a>
                     
                 </div>
                 
             </div>
        
    `;

    nav.innerHTML = dropdownHTML

    const btn = document.getElementById('perfil')
    const name = localStorage.getItem('name')
  
   btn.innerHTML += name


    ObtenerCantidadCanasta()
    
}

if (localStorage.getItem('sesion')) {

    DarLikePrevio()
}


async function DarLikePrevio() {
    
    const params = new URLSearchParams(window.location.search)
    
    const like = await fetch('/auth/like', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
            number: params.get('like'),
            sesion: localStorage.getItem('sesion'),
            estado: 0
         })
    }) 

    const data = await like.json()

    console.log(data);
    
}


async function ObtenerCantidadCanasta() {

    console.log('modificar');
    
    
    //Poner el numero de productos en la cesta
    const sesion = localStorage.getItem('sesion')
    const response = await fetch(`/auth/cantidad?sesion=${sesion}&token=${localStorage.getItem('token')}`)
    
    const data = await response.json()
    
    const carrit0 = document.querySelector('.btn_carrito')

    console.log(data);
    console.log(carrit0);
    
    

    if (data[0] && carrit0 !== null) {
        
        carrit0.childNodes[2].textContent = data[0].cantidad
    } else if (carrit0 !== null){
        carrit0.childNodes[2].textContent = '0'
    }
    
}

function CambiarFrame(link) {

    const frame = document.querySelector('iframe')

    console.log(frame);

    const barra = document.querySelector('.buscador')
    barra.value = ''
    
    if (link.getAttribute('jual') == 1) {
        sessionStorage.setItem('pag', '/compras')
         frame.src = '/compras'
    } else if (link.getAttribute('jual') == 2) {
        sessionStorage.setItem('pag', '/favoritos')
        frame.src = '/favoritos'
    } else if (link.getAttribute('jual') == 0) {
        sessionStorage.setItem('pag', '/tienda')
        frame.src = '/tienda'
    } else if (link.getAttribute('jual') == 3) {
        sessionStorage.setItem('pag', '/datos')
        frame.src = '/datos'
    } else if (link.getAttribute('jual') == 4) {
        sessionStorage.setItem('pag', '/home')
        frame.src = '/home'
    }
}

if (sessionStorage.getItem('pag')) {
        
    const frame = document.querySelector('iframe')

    frame.src = sessionStorage.getItem('pag')
}

        


